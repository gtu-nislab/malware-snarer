#!/usr/bin/env python
"""
    Extract MAIL Code sequence from executable file.
#
# Author: Necmettin Çarkacı
#
# E-mail: necmettin [ . ] carkaci [ @ ] gmail [ . ] com
#
# Usage :MAIL.py file
#   dataset : file or directory
"""

import os, sys
import subprocess


def getMAILCodeSequence(filename, extension='.mail', delimeter=','):
    """
        Extract MAIL Code sequence list into file.
        It use comma separator as default separator for MAIL Code in sequence

        Note : It used only for exe file

        :param filename: Binary filename
        :type filename : str
        :param extension: Output file extension
        :type extension: str

    """
    try:
        # Setup 3part Droid Native Library absolute path
        library_path = os.getcwd() + os.sep + "3part" + os.sep
        droid_native_library_path = library_path + "DroidNative" + os.sep
        droidNative_exe = droid_native_library_path + "DroidNative-Only-MAIL.exe "

        # FIXME: There is security problem here, shell parameter must be False
        subprocess.check_call(droidNative_exe+filename, shell=True)

        # rename file as mail extension
        if os.path.exists(filename+".mail"):
            dirname = os.path.dirname(filename+".mail")
            output_filename = os.path.basename(filename+".mail")
            (output_filename, ext) = os.path.splitext(filename)
            output_filename = dirname + os.sep + 'mail'+ os.sep + os.path.basename(output_filename)+'.mail'

            os.makedirs(os.path.dirname(output_filename), exist_ok=True)
            os.rename(filename+".mail",output_filename)

        return None

    except Exception as err:
        print("Error occured while exract MAIL sequence from "+filename+str(err))
        # FIXME: Log error here
