from virustotal import virustotal
import time
from pymongo import MongoClient
from os import walk

class bcolors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'


class Project:
    def __init__(self, dirName, vtToken):
        self.dirName = dirName
        self.vtToken = vtToken
        self.count = 0
        self.counter = 0
        self.flag = False

    def processAllFiles(self):
        allfiles=self.getAlreadyDonwloadedList()
        #allfiles = self.getAlreadyDonwloadedListFromFile()
        client = MongoClient('localhost', 27017)
        db = client['maldect']
        response_collection = db['vtresponses']

        for file in allfiles:
            if self.count == 4:
                print(bcolors.WARNING + "\nJSON object responses and it is limited to at most 4 requests! Wait a minute\n")
                time.sleep(60)  # Delay for 1 minute (60 seconds).
                self.count = 0
            else:

                isExist = response_collection.find_one({'md5': file[:len(file)-4]})

                self.print_status("\nIndex:", "    [ " + str(self.counter) + " ]", bcolors.OKBLUE)
                self.print_status("File name:", str(file), bcolors.OKBLUE)

                if( isExist != None):
                    self.print_status("Status:", "   This Object is already exist in MongoDB!! md5 : " + str(isExist['md5']), bcolors.FAIL)
                else:
                    jsonFile = virustotal.getVirustotalReport(self.dirName + "/" + file, self.vtToken)
                    #self.print_status("Json:", "     " + str(jsonFile), bcolors.OKBLUE)

                    if jsonFile.get('md5') == None:
                        self.print_status("Status:", "   Error file, doesnt have md5", bcolors.FAIL)
                    else:
                        post_id = virustotal.save_responseinMongo(jsonFile)
                        self.print_status("Status:", "   Data successfully stored in MongoDB!! md5 : " + str(jsonFile['md5']), bcolors.OKBLUE)
                    self.count = self.count + 1
                self.counter = self.counter + 1
        self.flag = True

    def print_status(self, status, message, color):
        print(bcolors.BOLD + bcolors.WARNING + status, end="    ")
        print(color + message)

    def getAlreadyDonwloadedList(self):
        filelist = []
        for (dirpath, dirnames, filenames) in walk(self.dirName):
            filelist.extend(filenames)
            break
        return filelist

    def getAlreadyDonwloadedListFromFile(self):
        with open('../VxVaultdownloadedList.txt') as f:
            list = f.read().splitlines()
        return list


project=Project("../exetemp", "5f53a02c561408cf58fca610f7998cafb7da61c0787771f05520346ac4abc002")
#jsonFile=virustotal.getVirustotalReport("./vxvaultvirus/tudosobrepalavras.com-wp-content-themes-islemag-img-sserv.jpg", project.vtToken)
#post_id = virustotal.save_responseinMongo(jsonFile)
project.processAllFiles()
