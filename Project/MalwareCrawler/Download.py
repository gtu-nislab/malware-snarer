
import urllib.request
from os import walk
import hashlib
import os
from MalwareCrawler import VxVault

class Download:
	def __init__(self):
		self.allUrlLists = ""
		self.alreadyDownloadedList = []

	# listedeki tum dosyalari indirir
	def download(self, link, filename):
		print("Link :      " + str(link))
		exestr = link[len(link) - 4:len(link) - 1]

		if exestr == "exe":
			try:
				urllib.request.urlretrieve(link, filename.rstrip('\r'))
				isdonwloaded, md5 = self.rename_with_md5(filename.rstrip('\r'))
				print("MD5:        " + md5)
				if isdonwloaded == -1:
					print("Status:     This file is already downloaded! \n")
				else:
					print("Status:     Successfully downloaded!! \n")

			except:
				print("Status:     Error link!!!!\n")
		else:
			print("Status:     Not exe fÄ±le! \n")

	# dosya indirme fonksiyonu. url= indirilecegi dosya, fileName=kaydedilecek isim
	def downloadAllFiles(self, allLinks,dirName):
		self.allUrlLists=allLinks
		self.dirName= dirName
		self.printLists(self.allUrlLists)
		self.alreadyDownloadedList = self.getAlreadyDonwloadedList()
		print("\nDownloading files\n")
		for url in self.allUrlLists:
			file = self.dirName + "/" + url[7:len(url)].replace("/", "-")
			self.download(url, file)

	def getAlreadyDonwloadedList(self):
		filelist = []
		for (dirpath, dirnames, filenames) in walk(self.dirName):
			filelist.extend(filenames)
			break
		return filelist

	def isAlreadyDownloaded(self, link):
		if link in self.alreadyDownloadedList:
			return -1
		else:
			return 0

	def rename_with_md5(self, file):

		# Open,close, read file and calculate MD5 on its contents
		with open(file, 'rb') as file_to_check:
			# read contents of the file
			data = file_to_check.read()
			# pipe contents of the file through
			md5_returned = hashlib.md5(data).hexdigest()

		isdonwloaded = self.isAlreadyDownloaded(md5_returned + '.exe')

		if isdonwloaded == -1:
			os.remove(file)
		else:
			os.rename(file, self.dirName + "/" + md5_returned + '.exe')
			newfile = "LINK => " + file[len(self.dirName) + 1:] + " *** MD5 => " + md5_returned + "\n"
			with open("../VxVaultdownloadedList.txt", "a") as myfile:
				myfile.write(newfile)
		return isdonwloaded, md5_returned


vxVault = VxVault("http://MalwareCrawler.net/URL_List.php", "../vxvaultvirus")


down=Download()
down.downloadUsingNIO("http://92.63.197.48/o.exe","/home/gulzada/Documents/bitirme/malwarePython/VxVault/92.63.197.48-o.exe")
