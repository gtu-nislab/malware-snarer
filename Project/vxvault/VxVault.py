
import urllib.request
from os import walk

#from ./virustotal import virustotal


#  "http://vxvault.net/URL_List.php" sitesindeki tum dosyalari indirir.


class VxVault:
    def __init__(self, urlPath,dirName):
        self.urlPath = urlPath
        self.allUrlLists =""
        self.dirName=dirName
        self.alreadyDownloadedList=[]
        
    # dosya indirme fonksiyonu. url= indirilecegi dosya, fileName=kaydedilecek isim
    def download(self, link,  filename):
        print("Link :      " + str(link))
        newfile = filename[len(self.dirName) + 1:]
        print("File name:  " + str(newfile))
        isdonwloaded = self.isAlreadyDownloaded(newfile)
        if isdonwloaded == -1:
            print("Status:     This file is already downloaded! \n")
        else:
            try:
                urllib.request.urlretrieve(link, filename.rstrip('\r'))
                with open("../downloadedList.txt", "a") as myfile:
                    myfile.write(newfile)
                print("Status:     Successfully downloaded! \n")
            except:
                print("Status:     Error link!!!!\n")
    # sitedeki tum listeyi ceker, http:// ile baslayanlari yeni listeye ekler
    def getAllLinks(self):
        with urllib.request.urlopen(self.urlPath) as response:
            data = response.read()
        print("\nGetting all links\n")
        httpString = "http"
        self.allUrlLists = list()
        allData = data.decode('utf8').split('\n')

        for link in allData:
            if httpString in link:
                link.replace("\n", "")
                self.allUrlLists.append(link)

    def printLists(self, urlList):
        for link in urlList:
            print(link)


    # listedeki tum dosyalari indirir    
    def downloadAllFiles(self):
        self.getAllLinks()
        self.printLists(self.allUrlLists)
        self.alreadyDownloadedList=self.getAlreadyDonwloadedList()
        print(self.alreadyDownloadedList)
        print("\nDownloading files\n")
        for url in self.allUrlLists:
            file = self.dirName + "/" + url[7:len(url)].replace("/", "-")
            self.download(url, file)

    def getAlreadyDonwloadedList(self):
        filelist=[]
        for (dirpath, dirnames, filenames) in walk(self.dirName):
            filelist.extend(filenames)
            break
        return filelist

    def isAlreadyDownloaded(self, link):
        if link[:len(link)-1] in self.alreadyDownloadedList:
            return -1
        else:
            return 0

vxVault = VxVault("http://vxvault.net/URL_List.php", "../exevirus")
vxVault.downloadAllFiles()

