from urllib.request import urlopen
import urllib.request
import virustotal
import pprint
#  "http://vxvault.net/URL_List.php" sitesindeki tum dosyalari indirir.


class VxVault:
    def __init__(self, urlPath, allUrlLists,dirName):
        self.urlPath = urlPath
        self.allUrlLists = allUrlLists
        self.dirName=dirName
    # dosya indirme fonksiyonu. url= indirilecegi dosya, fileName=kaydedilecek isim
    def download(self, url,  fileName):
        response = urlopen(url)
        data = response.read()
        file_ = open(fileName, 'w')
        file_.write(data)
        file_.close()

    # sitedeki tum listeyi ceker, http:// ile baslayanlari yeni listeye ekler
    def getAllLinks(self):
        response = urlopen(self.urlPath)
        data = response.read()
        httpString = "http"
        self.allUrlLists = list()
        allData = data.decode('utf8').split('\n')

        for link in allData:
            if httpString in link:
                self.allUrlLists.append(link)

    def printUrlLists(self):
        for link in self.allUrlLists:
            print(link)

    # verilen linkin ismini degistirip , o isimle indirecek
    # ornegin: "http://92.63.197.48/o.exe" ise "92.63.197.48-o.exe" seklinde
    def downoadFile(self, link):
        req = urllib.request.Request(link)
        try:
            response = urlopen(req)
            file = self.dirName+"/"+link[7:len(link)].replace("/", "-")
            self.download(link, file)
        except: 
            print("Error link -> "  + link)
    
    # listedeki tum dosyalari indirir    
    def downloadAllFiles(self):
        for url in self.allUrlLists:
            self.downoadFile(url)


jsonFile=virustotal.getVirustotalReport("a.exe","5f53a02c561408cf58fca610f7998cafb7da61c0787771f05520346ac4abc002")
print(jsonFile)
vxVault = VxVault("http://vxvault.net/URL_List.php", "","/home/gulzada/Documents/bitirme/VxVault")
#vxVault.getAllLinks()
#vxVault.printUrlLists()
#vxVault.downloadAllFiles()
post_id=virustotal.save_responseinMongo(jsonFile)
