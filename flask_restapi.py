import datetime
import time
from flask import Flask, jsonify , abort
from flask import request
from flask_pymongo import PyMongo

app = Flask(__name__)
app.config['MONGO_DBNAME'] = 'maldect'
app.config['MONGO_URI'] = 'mongodb://localhost:27017/maldect'

mongo = PyMongo(app)
APP_URL = "http://127.0.0.1:5000"

@app.route('/', methods=['POST'])
def add_new_post():
    post = mongo.db.post
    title = request.json['title']
    body = request.json['body']
    urlid = str(float(time.time())).replace(".", "")
    post_id = post.insert(
       {
            'title': title,
            'body': body,
            'createdate': datetime.datetime.now(),
            'status': 1,
            'urlid': urlid
        }
    )
    newpost = post.find_one({'_id': post_id})
    output = {
        'title': newpost['title'],
        'body': newpost['body'],
        'urlid': newpost['urlid']
    }
    return jsonify({'message': "Success", 'result': output, 'bodycount': len(body)}), 201

@app.route('/<md5>', methods=['GET'])
def get_post(md5):
    post = mongo.db.vtresponses
    p = post.find_one({'md5': md5})
    if p:
        output = {
            'md5': p['md5'],
            'scan_id': p['scan_id'],
            'sha1': p['sha1'],
            'resource': p['resource'],
            'response_code': p['response_code'],
            'scan_date': p['scan_date'],
            'permalink': p['permalink'],
            'verbose_msg': p['verbose_msg'],
            'total': p['total'],
            'positives': p['positives'],
            'sha256': p['sha256']


        }
        return jsonify({'result': output}), 200
    else:
        abort(404, {'message': "Article not found"})


if __name__ == '__main__':
    app.run(debug=True)