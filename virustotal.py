

import requests
import hashlib
import time
#from pymongo import MongoClient
import random
import fileutil


def getVirustotalReport(filename, API_KEY,isFile=1, proxy=None):

      headers = {
      "Accept-Encoding": "gzip, deflate",
      "User-Agent" : "gzip,  My Python requests library example client or username"
      }
      if(isFile):
        with open(filename, 'rb') as input_file:
            data = input_file.read()
            file_hash_value = hashlib.md5(data).hexdigest()

      else:
          file_hash_value = filename
      #print(file_hash_value)
      params = {'apikey': API_KEY, 'resource':file_hash_value}
      if(proxy is None):
        response = requests.get('https://www.virustotal.com/vtapi/v2/file/report',params=params, headers=headers)
      else:
          response = requests.get('https://www.virustotal.com/vtapi/v2/file/report', params=params, headers=headers,proxies=proxy)

      #FIXME: if result none there can be problem check this
      json_response = response.json()
      return json_response

def save_responseinMongo(json_resp):
    client = MongoClient()
    db = client['maldect']
    response_collection = db['vtresponses']
    #post = {"filename": "","path": "", "json_resp": json_resp}
    post_id = response_collection.insert(json_resp)
    return post_id


def extract_all_hashes(filepath):
    filelist = fileutil.getFilePaths(filepath, extensionList=[".exe",".dll"])
    fhs = []
    with open("hashofAllFiles.txt", 'w') as output_file:
        for file in filelist:
            fh = fileutil.getFileHash(file)
            fhs.append(fh)
            output_file.write(fh+"\n")
    return fhs
def get_hash_from_textfile(textfilepath):
    with open("hashofAllFiles.txt", 'r') as output_file:
        hashes = output_file.read().split('\n')
        if (len(hashes)<=0):
            raise Exception("no hash value in text file")
        return hashes



#calculateRequestCountPerDay(20000,fhs,api,validProxyList)